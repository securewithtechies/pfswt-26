# The Secret Missives (250 Points)

**Category:** Web Exploitation  
**Points:** 250  
**Difficulty:** Medium  
**Theme:** Peer Ali Khan - The First Martyr of 1857

**Challenge Website:** https://rahipatel1285.github.io/pfswt1/

---

## Challenge Overview

The resistance network used coded messages stored in browser storage. Players must discover a hidden JWT token in localStorage, decode it, and extract the flag from its payload.

---

## Prerequisites

Must complete Challenge 1 (The Bookseller's Code) first - challenges unlock progressively.

---

## Solution

### Step 1: Discover Hidden Storage

After completing Challenge 1, the hint mentions "storage". Investigate browser storage:

1. Open DevTools → Application → Local Storage
2. Look for unusual keys (some are Base64 encoded)
3. Find the key `cmVzaXN0YW5jZV90b2tlbg==`

### Step 2: Decode the Storage Key

```javascript
atob('cmVzaXN0YW5jZV90b2tlbg==')
// Result: "resistance_token"
```

### Step 3: Retrieve the JWT Token

```javascript
const key = btoa('resistance_token');
const jwt = localStorage.getItem(key);
console.log(jwt);
```

**Output:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwZWVyX2FsaV9raGFuIiwiaWF0IjoxODU3LCJleHAiOjIwMjUsInJvbGUiOiJmcmVlZG9tX2ZpZ2h0ZXIiLCJmbGFnIjoiY0dacjNRM1p...
```

### Step 4: Decode JWT Payload

JWT tokens have three parts separated by dots: `header.payload.signature`

```javascript
// Split JWT and decode the payload (second part)
const parts = jwt.split('.');
const payload = JSON.parse(atob(parts[1]));
console.log(payload);
```

**Decoded Payload:**
```json
{
  "sub": "peer_ali_khan",
  "iat": 1857,
  "exp": 2025,
  "role": "freedom_fighter",
  "flag": "cGZzd3R7UzNjcjN0X00xc3MxdjNfVGgzX0IwMGtfQzBkM19QNHRUNEGH"
}
```

### Step 5: Decode the Flag Field

The flag field is Base64 encoded:

```javascript
const encodedFlag = payload.flag;
const flag = atob(encodedFlag);
console.log(flag);
```

### Step 6: Submit for Verification

The challenge expects the full JWT token as input:

```javascript
Challenges.verify.flag2(jwt).then(result => {
    if (result.success) {
        console.log('FLAG:', result.flag);
        console.log('Next hint:', result.nextHint);
    }
});
```

---

## Complete Solution Script

```javascript
// One-liner solution
const key = btoa('resistance_token');
const jwt = localStorage.getItem(key);
const payload = JSON.parse(atob(jwt.split('.')[1]));
console.log('Decoded flag:', atob(payload.flag));

// Submit for verification
Challenges.verify.flag2(jwt).then(result => {
    if (result.success) {
        console.log('FLAG:', result.flag);
    }
});
```

---

## Flag

```
pfswt{S3cr3t_M1ss1v3_Th3_B00k_C0d3_P4tn4!}
```

---

## Common Mistakes

1. **Submitting the flag directly** instead of the JWT token
2. **Falling for honeypots** like `localStorage['flag']`
3. **Not completing Challenge 1** first (flag2 is locked)
4. **Trying to forge a JWT** (signature verification will fail)

---

## Technical Details

### JWT Structure
- **Header:** `{"alg":"HS256","typ":"JWT"}` - Algorithm and token type
- **Payload:** Contains claims including the flag
- **Signature:** HMAC-SHA256 ensuring integrity

### Why Base64?
- localStorage key is Base64 encoded to hide it from casual inspection
- JWT payload encoding is standard Base64
- Flag inside JWT is double-encoded for additional obfuscation

---

## Tools Used

- Browser DevTools (F12)
- Application → Local Storage inspection
- JavaScript console for Base64 decoding
- jwt.io for JWT structure analysis
