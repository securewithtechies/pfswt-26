# The Underground Network (500 Points)

**Category:** Web Exploitation  
**Points:** 500  
**Difficulty:** Hard  
**Theme:** Peer Ali Khan - The First Martyr of 1857

**Challenge Website:** https://rahipatel1285.github.io/pfswt1/

---

## Challenge Overview

The resistance communicated through an underground network using coded messages. Players must intercept simulated WebSocket messages, decode them using multiple cipher layers, and reconstruct the original message.

---

## Prerequisites

Must complete Challenges 1 and 2 first.

---

## Solution

### Step 1: Discover WebSocket Simulation

The hint from Challenge 2 mentions "Listen to the underground network...". This refers to a WebSocket simulation in the JavaScript.

```javascript
// Set up listener for WebSocket messages
Challenges.ws.onMessage((msg) => {
    console.log('Received:', msg);
});
```

### Step 2: Collect All Message Fragments

Messages arrive at timed intervals (2s, 5s, 8s, 12s, 15s, 18s after page load):

```javascript
const messages = [];

Challenges.ws.onMessage((msg) => {
    messages.push(msg);
    console.log(`Message ${messages.length}:`, msg);
});

// After ~20 seconds, check collected messages
setTimeout(() => {
    console.log('All messages:', Challenges.ws.getMessages());
}, 20000);
```

### Step 3: Analyze Message Structure

Each message has the format:
```javascript
{
    data: "base64_encoded_caesar_cipher",
    meta: { 
        s: shift_value,  // Caesar shift
        t: timestamp 
    }
}
```

### Step 4: Decode Each Fragment

```javascript
function caesarDecrypt(text, shift) {
    return text.replace(/[a-zA-Z]/g, function(char) {
        const base = char <= 'Z' ? 65 : 97;
        return String.fromCharCode(
            ((char.charCodeAt(0) - base - shift + 26) % 26) + base
        );
    });
}

function decodeFragment(msg) {
    // Base64 decode first
    const b64decoded = atob(msg.data);
    // Then Caesar cipher with shift from meta
    const shift = msg.meta.s;
    return caesarDecrypt(b64decoded, shift);
}

// Decode all fragments
const messages = Challenges.ws.getMessages();
const fragments = messages.map(decodeFragment);
console.log('Fragments:', fragments);
```

**Expected Fragments:**
```javascript
["Und3r", "gr0und_", "N3tw0rk_", "B1h4r_", "1857_", "Fr33d0m"]
```

### Step 5: Reconstruct the Flag

```javascript
// Combine fragments
const combined = fragments.join('');
const flag = `pfswt{${combined}!}`;
console.log('Reconstructed flag:', flag);
```

### Step 6: Submit for Verification

```javascript
Challenges.verify.flag3(flag).then(console.log);
```

---

## Complete Solution Script

```javascript
// Wait for page to load and all messages to arrive
setTimeout(async () => {
    // Helper function for Caesar decryption
    function caesarDecrypt(text, shift) {
        return text.replace(/[a-zA-Z]/g, function(char) {
            const base = char <= 'Z' ? 65 : 97;
            return String.fromCharCode(
                ((char.charCodeAt(0) - base - shift + 26) % 26) + base
            );
        });
    }
    
    // Get all WebSocket messages
    const messages = Challenges.ws.getMessages();
    
    // Decode each fragment
    const fragments = messages.map(msg => {
        const b64decoded = atob(msg.data);
        return caesarDecrypt(b64decoded, msg.meta.s);
    });
    
    // Combine and submit
    const combined = fragments.join('');
    const flag = `pfswt{${combined}!}`;
    
    console.log('Flag:', flag);
    
    const result = await Challenges.verify.flag3(flag);
    console.log('Verification:', result);
}, 20000);  // Wait 20 seconds for all messages
```

---

## Flag

```
pfswt{Und3rgr0und_N3tw0rk_B1h4r_1857_Fr33d0m!}
```

---

## Technical Details

### Cipher Chain
Each message fragment goes through two encoding layers:
1. **Caesar Cipher** - Classical shift cipher with variable shift per message
2. **Base64 Encoding** - Binary-to-text encoding

### Timing Pattern
Messages arrive at specific intervals to simulate a realistic underground communication network. Missing a message means missing part of the flag.

### WebSocket Simulation
While not using actual WebSocket connections, the challenge simulates the behavior using JavaScript timers and callbacks.

---

## Flag Breakdown

| Part | Meaning |
|------|---------|
| `Und3rgr0und` | Underground - the secret network |
| `N3tw0rk` | Network - communication system |
| `B1h4r` | Bihar - region of the 1857 uprising |
| `1857` | Year of the first war of independence |
| `Fr33d0m` | Freedom - the ultimate goal |

---

## Tools Used

- Browser DevTools (F12)
- JavaScript console
- Understanding of Base64 and Caesar cipher
